name: Daily ClickHouse Agent Stats Export

on:
  schedule:
    - cron: '0 2 * * *'  # daily at 02:00 UTC
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List Main folder (if exists)
        run: |
          echo "Listing Main folder contents (if present)"
          if [ -d "Main" ]; then
            find Main -type f -print || true
          else
            echo "Main folder not found"
          fi

      - name: Upload Main folder as artifact (ensures workflow retrieves all files within Main)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: main-folder
          path: Main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run export script
        env:
          CLICKHOUSE_URL: ${{ secrets.CLICKHOUSE_URL }}
          CLICKHOUSE_USER: ${{ secrets.CLICKHOUSE_USER }}
          CLICKHOUSE_PASSWORD: ${{ secrets.CLICKHOUSE_PASSWORD }}
          CLICKHOUSE_DATABASE: ${{ secrets.CLICKHOUSE_DATABASE }}
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          S3_KEY_PREFIX: ${{ secrets.S3_KEY_PREFIX }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          python scripts/export_daily_agent_stats.py

      - name: Upload produced CSVs as artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: daily-agent-stats
          path: exports/
